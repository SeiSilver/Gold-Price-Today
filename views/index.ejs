<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gold VN Track - BTMC Giá Vàng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container">
      <span class="navbar-brand mb-0 h1">Gold VN Track</span>
      <span class="text-white-50">Bao Tin Minh Chau</span>
    </div>
  </nav>

  <main class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <h2 class="mb-0">Biểu đồ Giá</h2>
        <select class="form-select form-select-lg" id="goldSelect" style="max-width: 360px;">
          <% if (goldNames && goldNames.length > 0) { %>
            <% goldNames.forEach(function(name) { %>
              <option value="<%= name %>" <%= name === selectedGoldName ? 'selected' : '' %>><%= name %></option>
            <% }); %>
          <% } else { %>
            <option>Chưa có dữ liệu</option>
          <% } %>
        </select>
      </div>
      <button type="button" class="btn btn-primary" id="fetchBtn" onclick="fetchBTMC()">
        <span class="fetch-text">Cập nhật giá ngay</span>
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
      </button>
    </div>
    <div class="row g-4 mb-4">
      <div class="col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-primary text-white">Biểu đồ Giá Mua</div>
          <div class="card-body">
            <canvas id="buyPriceChart" height="120"></canvas>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-success text-white">Biểu đồ Giá Bán</div>
          <div class="card-body">
            <canvas id="sellPriceChart" height="120"></canvas>
          </div>
        </div>
      </div>
    </div>

    <h2 class="mb-3">Bảng Giá Vàng Mới Nhất</h2>
    <div class="card shadow-sm overflow-hidden">
      <div class="table-responsive">
        <table class="table table-hover table-striped mb-0">
          <thead class="table-primary">
            <tr>
              <th>Tên Sản Phẩm</th>
              <th>Karat</th>
              <th class="text-end">Giá Mua (đ)</th>
              <th class="text-end">Giá Bán (đ)</th>
              <th>Giá Thế Giới</th>
              <th>Thời Gian</th>
            </tr>
          </thead>
          <tbody>
            <% if (latestPrices && latestPrices.length > 0) { %>
              <% latestPrices.forEach(function(row) { %>
                <tr>
                  <td><%= row.name %></td>
                  <td><%= row.karat %></td>
                  <td class="text-end"><%= Number(row.buy_price).toLocaleString('vi-VN') %></td>
                  <td class="text-end fw-bold"><%= Number(row.sell_price).toLocaleString('vi-VN') %></td>
                  <td><%= row.world_price || '-' %></td>
                  <td><%= row.recorded_at ? new Date(row.recorded_at).toLocaleString('vi-VN') : '-' %></td>
                </tr>
              <% }); %>
            <% } else { %>
              <tr>
                <td colspan="6" class="text-center text-muted py-4">Chưa có dữ liệu. Dữ liệu sẽ được cập nhật tự động mỗi ngày lúc 8:00 sáng.</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    async function fetchBTMC() {
      const btn = document.getElementById('fetchBtn');
      const text = btn.querySelector('.fetch-text');
      const spinner = btn.querySelector('.spinner-border');
      btn.disabled = true;
      text.textContent = 'Đang tải...';
      spinner.classList.remove('d-none');
      try {
        const res = await fetch('/api/fetch', { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          alert('Đã cập nhật ' + data.count + ' bản ghi giá vàng.');
          location.reload();
        } else {
          alert('Lỗi: ' + (data.error || 'Không xác định'));
        }
      } catch (e) {
        alert('Lỗi kết nối: ' + e.message);
      } finally {
        btn.disabled = false;
        text.textContent = 'Cập nhật giá ngay';
        spinner.classList.add('d-none');
      }
    }
  </script>
  <script>
    let buyChart, sellChart;

    function createPriceChart(canvasId, labels, values, borderColor, fillColor, label) {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return null;
      if (labels.length === 0 || values.length === 0) return null;
      const minVal = Math.min(...values);
      const maxVal = Math.max(...values);
      const padding = Math.max(1000, (maxVal - minVal) * 0.1);

      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: values,
            borderColor: borderColor,
            backgroundColor: fillColor,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: false,
              min: minVal - padding,
              max: maxVal + padding
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: (c) => c.parsed.y.toLocaleString('vi-VN') + ' đ'
              }
            }
          }
        }
      });
    }

    function updateCharts(labels, buyValues, sellValues) {
      if (buyChart) buyChart.destroy();
      if (sellChart) sellChart.destroy();
      buyChart = createPriceChart('buyPriceChart', labels, buyValues, 'rgb(13, 110, 253)', 'rgba(13, 110, 253, 0.1)', 'Giá Mua (VND)');
      sellChart = createPriceChart('sellPriceChart', labels, sellValues, 'rgb(25, 135, 84)', 'rgba(25, 135, 84, 0.1)', 'Giá Bán (VND)');
    }

    // Initial render
    updateCharts(
      <%- JSON.stringify(chartLabels || []) %>,
      <%- JSON.stringify(chartBuyValues || []) %>,
      <%- JSON.stringify(chartSellValues || []) %>
    );

    // Dropdown change: fetch new chart data
    document.getElementById('goldSelect').addEventListener('change', async function() {
      const name = encodeURIComponent(this.value);
      const select = this;
      select.disabled = true;
      try {
        const res = await fetch('/api/chart?name=' + name);
        const data = await res.json();
        updateCharts(data.chartLabels || [], data.chartBuyValues || [], data.chartSellValues || []);
      } catch (e) {
        console.error(e);
      } finally {
        select.disabled = false;
      }
    });
  </script>
</body>
</html>
